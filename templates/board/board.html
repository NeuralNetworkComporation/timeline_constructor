{% extends 'base.html' %}

{% block content %}
<div id="board-container" class="board-container">
    <!-- Простая доска для начала -->
    <div id="board" class="board">
        {% for timeline in timelines %}
        <div class="board-node"
             data-id="{{ timeline.id }}"
             style="left: {{ timeline.x }}px; top: {{ timeline.y }}px;
                    background: {{ timeline.background_color }};
                    border-color: {{ timeline.border_color }};">
            <div class="node-header" style="background: {{ timeline.color }};">
                {{ timeline.title }}
            </div>
            <div class="node-content">
                {{ timeline.description|truncatechars:100 }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .board-container {
        position: relative;
        width: 100vw;
        height: calc(100vh - 60px);
        overflow: hidden;
        background: #f8f9fa;
        cursor: move;
    }

    .board {
        position: absolute;
        width: 5000px;
        height: 5000px;
        background:
            linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
        background-size: 50px 50px;
    }

    .board-node {
        position: absolute;
        width: 250px;
        min-height: 150px;
        background: white;
        border: 2px solid #10b981;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        cursor: move;
    }

    .node-header {
        padding: 10px;
        color: white;
        font-weight: bold;
        border-radius: 6px 6px 0 0;
    }

    .node-content {
        padding: 10px;
    }
</style>

<script>
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;

    // Панорамирование доски
    const board = document.querySelector('.board-container');

    board.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.pageX - board.offsetLeft;
        startY = e.pageY - board.offsetTop;
        scrollLeft = board.scrollLeft;
        scrollTop = board.scrollTop;
        board.style.cursor = 'grabbing';
    });

    board.addEventListener('mouseleave', () => {
        isDragging = false;
        board.style.cursor = 'move';
    });

    board.addEventListener('mouseup', () => {
        isDragging = false;
        board.style.cursor = 'move';
    });

    board.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();

        const x = e.pageX - board.offsetLeft;
        const y = e.pageY - board.offsetTop;
        const walkX = (x - startX) * 2;
        const walkY = (y - startY) * 2;

        board.scrollLeft = scrollLeft - walkX;
        board.scrollTop = scrollTop - walkY;
    });

    // Перетаскивание узлов
    const nodes = document.querySelectorAll('.board-node');
    nodes.forEach(node => {
        let nodeDragging = false;
        let nodeStartX, nodeStartY, nodeLeft, nodeTop;

        node.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return; // Только левая кнопка

            nodeDragging = true;
            nodeStartX = e.clientX;
            nodeStartY = e.clientY;
            nodeLeft = parseFloat(node.style.left) || 0;
            nodeTop = parseFloat(node.style.top) || 0;

            node.style.zIndex = '1000';
            e.stopPropagation();
        });

        document.addEventListener('mousemove', (e) => {
            if (!nodeDragging) return;

            const deltaX = e.clientX - nodeStartX;
            const deltaY = e.clientY - nodeStartY;

            node.style.left = (nodeLeft + deltaX) + 'px';
            node.style.top = (nodeTop + deltaY) + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (!nodeDragging) return;

            nodeDragging = false;
            node.style.zIndex = '';

            // Сохраняем позицию
            const nodeId = node.dataset.id;
            const x = parseFloat(node.style.left) || 0;
            const y = parseFloat(node.style.top) || 0;

            fetch(`/board/timeline/${nodeId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ x, y })
            });
        });
    });

    // Создание нового узла по правому клику
    board.addEventListener('contextmenu', (e) => {
        e.preventDefault();

        const rect = board.getBoundingClientRect();
        const x = e.clientX - rect.left + board.scrollLeft;
        const y = e.clientY - rect.top + board.scrollTop;

        const title = prompt('Название таймлайна:');
        if (!title) return;

        fetch('/board/timeline/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                x: x,
                y: y
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    });

    // Вспомогательная функция
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}